

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Pythonic code &mdash; Clean Code Python</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/styles.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="General traits of good code" href="../3_general_traits/index.html" />
    <link rel="prev" title="Docstrings and annotations" href="../1_docstrings_and_annotations/index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Clean Code in Python
          

          
            
            <img src="../../_static/logo-white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2019.12
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1_docstrings_and_annotations/index.html">Docstrings and annotations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pythonic code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#indexes-and-slices">1. Indexes and slices</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-your-own-sequences">1.1. Creating your own sequences</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#context-managers">2. Context managers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#implementing-context-managers">2.1. Implementing context managers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#properties-attributes-and-different-types-of-methods-for-objects">3. Properties, attributes and different types of methods for objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#underscores-in-python">3.1. Underscores in Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="#properties">3.2 Properties</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#iterable-objects">4. Iterable objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creating-iterable-objects">4.1. Creating iterable objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-sequences">4.2. Creating sequences</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#container-objects">5. Container objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dynamic-attributes-for-objects">6. Dynamic attributes for objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#callable-objects">7. Callable objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caveats-in-python">8. Caveats in Python</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mutable-default-arguments">8.1. Mutable default arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extending-built-in-types">8.2. Extending built-in types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../3_general_traits/index.html">General traits of good code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4_solid_principles/index.html">The SOLID principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5_decorators/index.html">Using decorators to improve our code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6_descriptors/index.html">Getting more out of our objects with descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../7_generators/index.html">Using generators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../8_unit_testing/index.html">Unit testing and refactoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../9_design_patterns/index.html">Common design patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10_clean_architecture/index.html">Clean architecture</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Clean Code in Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Pythonic code</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/chapters/2_pythonic_code/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="../3_general_traits/index.html" class="btn btn-neutral float-right" title="General traits of good code" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../1_docstrings_and_annotations/index.html" class="btn btn-neutral float-left" title="Docstrings and annotations" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pythonic-code">
<h1>Pythonic code<a class="headerlink" href="#pythonic-code" title="Permalink to this headline">¶</a></h1>
<div class="section" id="indexes-and-slices">
<h2>1. Indexes and slices<a class="headerlink" href="#indexes-and-slices" title="Permalink to this headline">¶</a></h2>
<p>In Python, some data structures or types support accesing it’s elements by index. The first element is placed in the
index number zero. How would you access the last element of a list?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<span class="go">3</span>
</pre></div>
</div>
<p>In addition, we can obtain many elements by using <code class="docutils literal notranslate"><span class="pre">slice</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="go">(3, 4, 5)</span>
</pre></div>
</div>
<p>In this case, the syntax means that we get all of the elements on the tuple, starting from the index of the first number
(inclusive), up to the index on the second one (not including it).</p>
<p>You can exclude either one of the intervals, start or stop, and in that case, it will act from the beginning or end of
the sequence:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span> <span class="n">numbers</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
<span class="go">(1, 2, 3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="go">(4, 5)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span><span class="p">[::]</span>
<span class="go">(1, 2, 3, 4, 5)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="go">(2, 4)</span>
</pre></div>
</div>
<p>In the first example, it will everything up to index 3. In the second example, it will get all numbers starting from
index 3. In the third example, where both ends are excluded, it is actually creating a copy of the original tuple. The
last example includes a third parameter, which is the step.</p>
<p>In all of these cases, when we pass intervals to a sequence, what is actually happening is that we are passing a
<code class="docutils literal notranslate"><span class="pre">slice</span></code>. Note that it is a built-in object in Python that you can build yourself and pass directly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">interval</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span> <span class="n">numbers</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>
<span class="go">(2, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">interval</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span> <span class="n">numbers</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">numbers</span><span class="p">[</span><span class="n">interval</span><span class="p">]</span>
<span class="go">True</span>
</pre></div>
</div>
<div class="section" id="creating-your-own-sequences">
<h3>1.1. Creating your own sequences<a class="headerlink" href="#creating-your-own-sequences" title="Permalink to this headline">¶</a></h3>
<p>The functionality we just discussed works thanks to a magic method called <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>. This is the method that is
called when something like <code class="docutils literal notranslate"><span class="pre">object[key]</span></code> is called, passing the key as a parameter. A sequence is an object that
implements both <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">__len__</span></code>, and for this reason, it can be iterated over.</p>
<p>In the case that your class is a wrapper around a standard library object, you might as well delegate the behavior as
much as possible to the underlying object. This means that if your class is actually a wrapper on the list, call all of
the same methods on that list to make sure that it remains compatible. In the following listing, we can see an example
of how an object wraps a list, and for the methods we are interested in, we just delegate to its corresponding version
on the list object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Items</span><span class="p">:</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

     <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">)</span>

     <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>If you are implementing your own sequence then keep in mind the following points:</p>
<ul class="simple">
<li><p>When indexing by a range, the result should be an instance of the same type of the class.</p></li>
<li><p>In the range provided by the slice, respect the semantics that Python uses, excluding the element at the end.</p></li>
</ul>
</div>
</div>
<div class="section" id="context-managers">
<h2>2. Context managers<a class="headerlink" href="#context-managers" title="Permalink to this headline">¶</a></h2>
<p>Context managers are quite useful since they correctly respond to a pattern. The pattern is actually every situation
where we want to run some code, and has preconditions and postconditions, meaning that we want to run things before and
after a certain main action.</p>
<p>Most of the time, we see context managers around resource management. For example, on situations when we open files, we
want to make sure that they are closed after processing (so we do not leak file descriptors), or if we open a connection
to a service (or even a socket), we also want to be sure to close it accordingly, or when removing temporary files, and
so on.</p>
<p>In all of these cases, you would normally have to remember to free all of the resources that were allocated and that is
just thinking about the best case—but what about exceptions and error handling? Given the fact that handling all
possible combinations and execution paths of our program makes it harder to debug, the most common way of addressing
this issue is to put the cleanup code on a <code class="docutils literal notranslate"><span class="pre">finally</span></code> block so that we are sure we do not miss it. For example, a very
simple case would look like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">process_file</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Nonetheless, there is a much elegant and Pythonic way of achieving the same thing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
    <span class="n">process_file</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</pre></div>
</div>
<p>The with statement enters the context manager. In this case, the open function implements the context manager protocol,
which means that the file will be automatically closed when the block is finished, even if an exception occurred.</p>
<p>Context managers consist of two magic methods: <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. On the first line of the context manager,
the with statement will call the first method, <code class="docutils literal notranslate"><span class="pre">__enter__</span></code>, and whatever this method returns will be assigned to the
variable labeled after as. This is optional—we don’t really need to return anything specific on the <code class="docutils literal notranslate"><span class="pre">__enter__</span></code>
method, and even if we do, there is still no strict reason to assign it to a variable if it is not required.</p>
<p>After this line is executed, the code enters a new context, where any other Python code can be run. After the last
statement on that block is finished, the context will be exited, meaning that Python will call the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method
of the original context manager object we first invoked.</p>
<p>If there is an exception or error inside the context manager block, the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method will still be called, which
makes it convenient for safely managing cleaning up conditions. In fact, this method receives the exception that was
triggered on the block in case we want to handle it in a custom fashion.</p>
<p>Despite the fact that context managers are very often found when dealing with resources,
this is not the sole application they have. We can implement our own context managers in order to handle the particular
logic we need.</p>
<p>Context managers are a good way of separating concerns and isolating parts of the code that should be kept independent,
because if we mix them, then the logic will become harder to maintain.</p>
<p>As an example, consider a situation where we want to run a backup of our database with a script. The caveat is that the
backup is offline, which means that we can only do it while the database is not running, and for this we have to stop
it. After running the backup, we want to make sure that we start the process again, regardless of how the process of the
backup itself went. Now, the first approach would be to create a huge monolithic function that tries to do everything
in the same place, stop the service, perform the backup task, handle exceptions and all possible edge cases, and then
try to restart the service again. You can imagine such a function, and for that reason, I will spare you the details,
and instead come up directly with a possible way of tackling this issue with context managers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DBHandler</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stop_database</span><span class="p">():</span>
        <span class="n">run</span><span class="p">(</span><span class="s2">&quot;systemctl stop postgresql.service&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_database</span><span class="p">():</span>
        <span class="n">run</span><span class="p">(</span><span class="s2">&quot;systemctl start postgresql.service&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_database</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="n">ex_traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_database</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">db_backup</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s2">&quot;pg_dump database&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">DBHandler</span><span class="p">():</span>
        <span class="n">db_backup</span><span class="p">()</span>
</pre></div>
</div>
<p>As a general rule, it should be good practice (although not mandatory), to always return something on the <code class="docutils literal notranslate"><span class="pre">__enter__</span></code>.</p>
<p>Notice the signature of the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method. It receives the values for the exception that was raised on the block.
If there was no exception on the block, they are all none.</p>
<p>The return value of <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> is something to consider. Normally, we would want to leave the method as it is, without
returning anything in particular. If this method returns True, it means that the exception that was potentially raised
will not propagate to the caller and will stop there. Sometimes, this is the desired effect, maybe even depending on the
type of exception that was raised, but in general it is not a good idea to swallow the exception. Remember: errors
should never pass silently.</p>
<p>Keep in mind not to accidentally return True on the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. If you do, make sure that this is exactly what you
want, and that there is a good reason for it.</p>
<div class="section" id="implementing-context-managers">
<h3>2.1. Implementing context managers<a class="headerlink" href="#implementing-context-managers" title="Permalink to this headline">¶</a></h3>
<p>In general, we can implement context managers implementing the <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> magic methods, and then
that object will be able to support the context manager protocol. While this is the most common way for context managers
to be implemented, it is not the only one.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">contextlib</span></code> module contains a lot of helper functions and objects to either implement context managers or use
some already provided ones that can help us write more compact code.</p>
<p>Let’s start by looking at the <code class="docutils literal notranslate"><span class="pre">contextmanager</span></code> decorator. When the <code class="docutils literal notranslate"><span class="pre">contextlib.contextmanager</span></code> decorator is applied
to a function, it converts the code on that function into a context manager. The function in question has to be a
particular kind of function called a generator function, which will separate the statements into what is going to be on
the <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> magic methods, respectively.</p>
<p>The equivalent code of the previous example can be rewritten with the <code class="docutils literal notranslate"><span class="pre">contextmanager</span></code> decorator like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">db_handler</span><span class="p">():</span>
    <span class="n">stop_database</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">start_database</span><span class="p">()</span>

<span class="k">with</span> <span class="n">db_handler</span><span class="p">():</span>
 <span class="n">db_backup</span><span class="p">()</span>
</pre></div>
</div>
<p>Here, we define the generator function and apply the <code class="docutils literal notranslate"><span class="pre">&#64;contextlib.contextmanager</span></code> decorator to it. The function
contains a yield statement, which makes it a generator function. Again, details on generators are not relevant in this case. All we need to know is
that when this decorator is applied, everything before the yield statement will be run as if it were part of the
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> method. Then, the yielded value is going to be the result of the context manager evaluation (what
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> would return), and what would be assigned to the variable if we chose to assign it.</p>
<p>At that point, the generator function is suspended, and the context manager is entered, where, again, we run the backup
code for our database. After this completes, the execution resumes, so we can consider that every line that comes after
the yield statement will be part of the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> logic.</p>
<p>Another helper we could use is <code class="docutils literal notranslate"><span class="pre">contextlib.ContextDecorator</span></code>. This is a mixin base class that provides the logic for
applying a decorator to a function that will make it run inside the context manager, while the logic for the context
manager itself has to be provided by implementing the aforementioned magic methods.</p>
<p>In order to use it, we have to extend this class and implement the logic on the required methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">dbhandler_decorator</span><span class="p">(</span><span class="n">contextlib</span><span class="o">.</span><span class="n">ContextDecorator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stop_database</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext_type</span><span class="p">,</span> <span class="n">ex_value</span><span class="p">,</span> <span class="n">ex_traceback</span><span class="p">):</span>
        <span class="n">start_database</span><span class="p">()</span>

<span class="nd">@dbhandler_decorator</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">offline_backup</span><span class="p">():</span>
    <span class="n">run</span><span class="p">(</span><span class="s2">&quot;pg_dump database&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is no with statement. We just have to call the function, <code class="docutils literal notranslate"><span class="pre">and</span> <span class="pre">offline_backup()</span></code> will automatically run inside a
context manager. This is the logic that the base class provides to use it as a decorator that wraps the original
function so that it runs inside a context manager.</p>
<p>The only downside of this approach is that by the way the objects work, they are completely independent (the decorator
doesn’t know anything about the function that is decorating, and vice versa. This, however good, means that you cannot
get an object that you would like to use inside the context manager, so if you really need to use the object returned by
the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method, one of the previous approaches will have to be the one of choice.</p>
<p>Being a decorator also poses the advantage that the logic is defined only once, and we can reuse it as many times as we
want by simply applying the decorators to other functions that require the same invariant logic.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">contextlib.suppress</span></code> is a util package that enters a context manager, which, if one of the provided
exceptions is raised, doesn’t fail. It’s similar to running that same code on a try/except block and passing an
exception or logging it, but the difference is that calling the suppress method makes it more explicit that those
exceptions that are controlled as part of our logic. For example, consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextlib</span>

<span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">DataConversionException</span><span class="p">):</span>
     <span class="n">parse_data</span><span class="p">(</span><span class="n">input_json_or_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, the presence of the exception means that the input data is already in the expected format, so there is no need for
conversion, hence making it safe to ignore it.</p>
</div>
</div>
<div class="section" id="properties-attributes-and-different-types-of-methods-for-objects">
<h2>3. Properties, attributes and different types of methods for objects<a class="headerlink" href="#properties-attributes-and-different-types-of-methods-for-objects" title="Permalink to this headline">¶</a></h2>
<p>All of the properties and functions of an object are public in Python, which is different from other languages where
properties can be public, private, or protected. That is, there is no point in preventing caller objects from invoking
any attributes an object has. This is another difference with respect to other programming languages in which you can
mark some attributes as private or protected.</p>
<p>There is no strict enforcement, but there are some conventions. An attribute that starts with an underscore is meant to
be private to that object, and we expect that no external agent calls it (but again, there is nothing preventing this).</p>
<div class="section" id="underscores-in-python">
<h3>3.1. Underscores in Python<a class="headerlink" href="#underscores-in-python" title="Permalink to this headline">¶</a></h3>
<p>Consider the following example to illustrate this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Connector</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Connector</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">source</span>
<span class="go">&#39;postgresql://localhost&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">Connector</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">_timeout</span>
<span class="go">60</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">Connector</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">__password</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr"> File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr">AttributeError</span>: <span class="n">&#39;Connector&#39; object has no attribute &#39;__password&#39;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">vars</span><span class="p">(</span><span class="n">Connector</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="go">{&#39;source&#39;: &#39;postgresql://localhost&#39;, &#39;_timeout&#39;: 60, &#39;user&#39;: &#39;root&#39;, &#39;_Connector__password&#39;: &#39;1234&#39;}</span>
</pre></div>
</div>
<p>Here, a Connector object is created with source, and it starts with 4 attributes—the
aforementioned <code class="docutils literal notranslate"><span class="pre">source</span></code>, <code class="docutils literal notranslate"><span class="pre">timeout</span></code>, <code class="docutils literal notranslate"><span class="pre">user</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code>. <code class="docutils literal notranslate"><span class="pre">source</span></code> and <code class="docutils literal notranslate"><span class="pre">user</span></code> are public, <code class="docutils literal notranslate"><span class="pre">timeout</span></code> is
private and <code class="docutils literal notranslate"><span class="pre">password</span></code> is.</p>
<p>However, as we can see from the following lines when we create an object like this, we can actually access <code class="docutils literal notranslate"><span class="pre">timeout</span></code>.
The interpretation of this code is that <code class="docutils literal notranslate"><span class="pre">_timeout</span></code> should be accessed only within connector itself and never from a
caller. This means that you should organize the code in a way so that you can safely refactor the timeout at all of the
times it’s needed, relying on the fact that it’s not being called from outside the object (only internally), hence
preserving the same interface as before. Complying with these rules makes the code easier to maintain and more
robust because we don’t have to worry about ripple effects when refactoring. The same principle applies to methods as
well.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Objects should only expose those attributes and methods that are relevant to an external caller object,
namely, entailing its interface. Everything that is not strictly part of an object’s interface should be kept prefixed
with a single underscore.</p>
</div>
<p>This is the Pythonic way of clearly delimiting the interface of an object. There is, however, a common misconception
that some attributes and methods can be actually made private. This is, again, a misconception.</p>
<p><code class="docutils literal notranslate"><span class="pre">password</span></code> is defined with a double underscore instead. Some developers use this method to hide some attributes,
thinking, like in this example, that <code class="docutils literal notranslate"><span class="pre">password</span></code> is now private and that no other object can modify it. Now, take a
look at the exception that is raised when trying to access it. It’s <code class="docutils literal notranslate"><span class="pre">AttributeError</span></code>, saying that it doesn’t exist.
It doesn’t say something like “this is private” or “this can’t be accessed” and so on. It says it does not exist. This
should give us a clue that, in fact, something different is happening and that this behavior is instead just a side
effect, but not the real effect we want.</p>
<p>What’s actually happening is that with the double underscores, Python creates a different name for the attribute (this
is called <strong>name mangling</strong>). What it does is create the attribute with the following name instead:
“_&lt;class-name&gt;__&lt;attribute-name&gt;”. In this case, an attribute named ‘_Connector__password’ will be created.</p>
<p>Notice the side effect that we mentioned earlier—the attribute only exists with a different name, and for that reason
the AttributeError was raised on our first attempt to access it.</p>
<p>The idea of the double underscore in Python is completely different. It was created as a means to override different
methods of a class that is going to be extended several times, without the risk of having collisions with the method
names. Even that is a too far-fetched use case as to justify the use of this mechanism.</p>
<p>Double underscores are a non-Pythonic approach. If you need to define attributes as private, use a single underscore,
and respect the Pythonic convention that it is a private attribute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not use double underscores.</p>
</div>
</div>
<div class="section" id="properties">
<h3>3.2 Properties<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<p>When the object needs to just hold values, we can use regular attributes. Sometimes, we might want to do some
computations based on the state of the object and the values of other attributes. Most of the time, properties are a
good choice for this.</p>
<p>Properties are to be used when we need to define access control to some attributes in an object, which is another point
where Python has its own way of doing things. In other programming languages (like Java), you would create access
methods (getters and setters), but idiomatic Python would use properties instead.</p>
<p>Imagine that we have an application where users can register and we want to protect certain information about the user
from being incorrect, such as their email, as shown in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="n">EMAIL_FORMAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^@]+@[^@]+\.[^@]+&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_valid_email</span><span class="p">(</span><span class="n">potentially_valid_email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">EMAIL_FORMAT</span><span class="p">,</span> <span class="n">potentially_valid_email</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_email</span> <span class="o">=</span> <span class="bp">None</span>

     <span class="nd">@property</span>
     <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_email</span>

     <span class="nd">@email.setter</span>
     <span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_email</span><span class="p">):</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_email</span><span class="p">(</span><span class="n">new_email</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Can&#39;t set {new_email} as it&#39;s not a valid email&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_email</span> <span class="o">=</span> <span class="n">new_email</span>
</pre></div>
</div>
<p>By putting <code class="docutils literal notranslate"><span class="pre">email</span></code> under a property, we obtain some advantages for free. In this example, the first <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>
method will return the value held by the private attribute <code class="docutils literal notranslate"><span class="pre">email</span></code>. As mentioned earlier, the leading underscore
determines that this attribute is intended to be used as private, and therefore should not be accessed from outside this
class.</p>
<p>Then, the second method uses <code class="docutils literal notranslate"><span class="pre">&#64;email.setter</span></code>, with the already defined property of the previous method. This is the
one that is going to be called when <code class="docutils literal notranslate"><span class="pre">&lt;user&gt;.email</span> <span class="pre">=</span> <span class="pre">&lt;new_email&gt;</span></code> runs from the caller code, and <code class="docutils literal notranslate"><span class="pre">&lt;new_email&gt;</span></code> will
become the parameter of this method. Here, we explicitly defined a validation that will fail if the value that is trying
to be set is not an actual email address. If it is, it will then update the attribute with the new value as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;jsmith&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;jsmith@&quot;</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ValueError</span>: <span class="n">Can&#39;t set jsmith@ as it&#39;s not a valid email</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;jsmith@g.co&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">email</span>
<span class="go">&#39;jsmith@g.co&#39;</span>
</pre></div>
</div>
<p>This approach is much more compact than having custom methods prefixed with <code class="docutils literal notranslate"><span class="pre">get_</span></code> or <code class="docutils literal notranslate"><span class="pre">set_</span></code>. It’s clear what is
expected because it’s just email.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Don’t write custom <code class="docutils literal notranslate"><span class="pre">get_*</span></code> and <code class="docutils literal notranslate"><span class="pre">set_*</span></code> methods for all attributes on your objects. Most of the time, leaving
them as regular attributes is just enough. If you need to modify the logic for when an attribute is retrieved or
modified, then use properties.</p>
</div>
<p>You might find that properties are a good way to achieve command and query separation (CC08). Command and query
separation state that a method of an object should either answer to something or do something, but not both. If a method
of an object is doing something and at the same time it returns a status answering a question of how that operation
went, then it’s doing more than one thing, clearly violating the principle that functions should do one thing, and one
thing only.</p>
<p>Depending on the name of the method, this can create even more confusion, making it harder for readers to understand
what the actual intention of the code is. For example, if a method is called set_email, and we use it as
if self.set_email(“<a class="reference external" href="mailto:a&#37;&#52;&#48;j&#46;com">a<span>&#64;</span>j<span>&#46;</span>com</a>”): …, what is that code doing? Is it setting the email to <a class="reference external" href="mailto:a&#37;&#52;&#48;j&#46;com">a<span>&#64;</span>j<span>&#46;</span>com</a>? Is it checking if the
email is already set to that value? Both (setting and then checking if the status is correct)?</p>
<p>With properties, we can avoid this kind of confusion. The <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> decorator is the query that will answer to
something, and the <code class="docutils literal notranslate"><span class="pre">&#64;&lt;property_name&gt;.setter</span></code> is the command that will do something.</p>
<p>Another piece of good advice derived from this example is as follows: don’t do more than one thing on a method. If you
want to assign something and then check the value, break that down into two or more sentences.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Methods should do one thing only. If you have to run an action and then check for the status, so that in separate
methods that are called by different statements.</p>
</div>
</div>
</div>
<div class="section" id="iterable-objects">
<h2>4. Iterable objects<a class="headerlink" href="#iterable-objects" title="Permalink to this headline">¶</a></h2>
<p>In Python, we have objects that can be iterated by default: lists, tuples, sets and dictionaries. However, the built-in
iterable objects are not the only kind that we can have in a for loop. We could also create our own iterable, with the
logic we define for iteration.</p>
<p>In order to achieve this, we rely on magic methods. Iteration works in Python by its own protocol (namely the iteration
protocol). When you try to iterate an object in the form <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">e</span> <span class="pre">in</span> <span class="pre">myobject:</span></code>…, what Python checks at a very high
level are the following two things, in order:</p>
<ul class="simple">
<li><p>If the object contains one of the iterator methods <code class="docutils literal notranslate"><span class="pre">__next__</span></code> or <code class="docutils literal notranslate"><span class="pre">__iter__</span></code></p></li>
<li><p>If the object is a sequence and has <code class="docutils literal notranslate"><span class="pre">__len__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code></p></li>
</ul>
<p>Therefore, as a fallback mechanism, sequences can be iterated, and so there are two ways of customizing our objects to
be able to work on for loops.</p>
<div class="section" id="creating-iterable-objects">
<h3>4.1. Creating iterable objects<a class="headerlink" href="#creating-iterable-objects" title="Permalink to this headline">¶</a></h3>
<p>When we try to iterate an object, Python will call the <code class="docutils literal notranslate"><span class="pre">iter()</span></code> function over it. One of the first things this
function checks for is the presence of the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method on that object, which, if present, will be executed.</p>
<p>The following code creates an object that allows iterating over a range of dates, producing one day at a time on every
round of the loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="k">class</span> <span class="nc">DateRangeIterable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An iterable that contains its own iterator object.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span> <span class="o">=</span> <span class="n">start_date</span>

 <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>

 <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="n">today</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">today</span>
</pre></div>
</div>
<p>This object is designed to be created with a pair of dates, and when iterated, it will produce each day in the interval
of specified dates, which is shown in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">DateRangeIterable</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>

<span class="go">2018-01-01</span>
<span class="go">2018-01-02</span>
<span class="go">2018-01-03</span>
<span class="go">2018-01-04</span>
</pre></div>
</div>
<p>Here, the for loop is starting a new iteration over our object. At this point, Python will call the <code class="docutils literal notranslate"><span class="pre">iter()</span></code> function
on it, which in turn will call the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> magic method. On this method, it is defined to return <code class="docutils literal notranslate"><span class="pre">self</span></code>,
indicating that the object is an iterable itself, so at that point every step of the loop will call the <code class="docutils literal notranslate"><span class="pre">next()</span></code>
function on that object, which delegates to the <code class="docutils literal notranslate"><span class="pre">__next__</span></code> method. In this method, we decide how to produce the
elements and return one at a time. When there is nothing else to produce, we have to signal this to Python by raising
the StopIteration exception.</p>
<p>This means that what is actually happening is similar to Python calling <code class="docutils literal notranslate"><span class="pre">next()</span></code> every time on our object until there
is a StopIteration exception, on which it knows it has to stop the for loop:</p>
<p>This example works, but it has a small problem—once exhausted, the iterable will continue to be empty, hence raising
StopIteration. This means that if we use this on two or more consecutive for loops, only the first one will work, while
the second one will be empty:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">r1</span> <span class="o">=</span> <span class="n">DateRangeIterable</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">r1</span><span class="p">))</span>
<span class="go">&#39;2018-01-01, 2018-01-02, 2018-01-03, 2018-01-04&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr"> File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr">ValueError</span>: <span class="n">max() arg is an empty sequence</span>
</pre></div>
</div>
<p>This is because of the way the iteration protocol works: an iterable constructs an iterator, and this one is the one
being iterated over. In our example, <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> just returned self, but we can make it create a new iterator every
time it is called. One way of fixing this would be to create new instances of DateRangeIterable, which is not a
terrible issue, but we can make <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> use a generator (which are iterator objects), which is being created
every time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DateRangeContainerIterable</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
        <span class="k">while</span> <span class="n">current_day</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">current_day</span>

        <span class="n">current_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>And this time, it works:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">r1</span> <span class="o">=</span> <span class="n">DateRangeContainerIterable</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">r1</span><span class="p">))</span>
<span class="go">&#39;2018-01-01, 2018-01-02, 2018-01-03, 2018-01-04&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
<span class="go">datetime.date(2018, 1, 4)</span>
</pre></div>
</div>
<p>The difference is that each for loop is calling <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> again, and each one of those is creating the generator
again. This is called a container iterable.</p>
<p>..note:: In general, it is a good idea to work with container iterables when dealing with generators.</p>
</div>
<div class="section" id="creating-sequences">
<h3>4.2. Creating sequences<a class="headerlink" href="#creating-sequences" title="Permalink to this headline">¶</a></h3>
<p>Maybe our object does not define the <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code> method, but we still want to be able to iterate over it. If
<code class="docutils literal notranslate"><span class="pre">__iter__</span></code> is not defined on the object, the <code class="docutils literal notranslate"><span class="pre">iter()</span></code> function will look for the presence of <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, and if
this is not found, it will raise TypeError.</p>
<p>A sequence is an object that implements <code class="docutils literal notranslate"><span class="pre">__len__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and expects to be able to get the elements it
contains, one at a time, in order, starting at zero as the first index. This means that you should be careful in the
logic so that you correctly implement <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> to expect this type of index, or the iteration will not work.</p>
<p>The example from the previous section had the advantage that it uses less memory. This means that is only holding one
date at a time, and knows how to produce the days one by one. However, it has the drawback that if we want to get the
n-th element, we have no way to do so but iterate n-times until we reach it. This is a typical trade-off in computer
science between memory and CPU usage.</p>
<p>The implementation with an iterable will use less memory, but it takes up to O(n) to get an element, whereas
implementing a sequence will use more memory (because we have to hold everything at once), but supports indexing in
constant time, O(1).</p>
<p>This is what the new implementation might look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DateRangeSequence</span><span class="p">:</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_range</span><span class="p">()</span>

     <span class="k">def</span> <span class="nf">_create_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">days</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">current_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>

         <span class="k">while</span> <span class="n">current_day</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
             <span class="n">days</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_day</span><span class="p">)</span>
             <span class="n">current_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

         <span class="k">return</span> <span class="n">days</span>

     <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_no</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">[</span><span class="n">day_no</span><span class="p">]</span>

     <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is how the object behaves:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">DateRangeSequence</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
<span class="go">2018-01-01</span>
<span class="go">2018-01-02</span>
<span class="go">2018-01-03</span>
<span class="go">2018-01-04</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">datetime.date(2018, 1, 1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="go">datetime.date(2018, 1, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">datetime.date(2018, 1, 4)</span>
</pre></div>
</div>
<p>In the preceding code, we can see that negative indices also work. This is because the DateRangeSequence object
delegates all of the operations to its wrapped object (a list), which is the best way to maintain compatibility and a
consistent behavior.</p>
<p>Evaluate the trade-off between memory and CPU usage when deciding which one of the two possible implementations to use.
In general, the iteration is preferable (and generators even more), but keep in mind the requirements of every case.</p>
</div>
</div>
<div class="section" id="container-objects">
<h2>5. Container objects<a class="headerlink" href="#container-objects" title="Permalink to this headline">¶</a></h2>
<p>Containers are objects that implement a <code class="docutils literal notranslate"><span class="pre">__contains__</span></code> method (that usually returns a Boolean value). This method is
called in the presence of the <code class="docutils literal notranslate"><span class="pre">in</span></code> keyword of Python. Something like <code class="docutils literal notranslate"><span class="pre">element</span> <span class="pre">in</span> <span class="pre">container</span></code> becomes
<code class="docutils literal notranslate"><span class="pre">container.__contains__(element)</span></code>.</p>
<p>You can imagine how much more readable and Pythonic the code can be when this method is properly implemented.</p>
<p>Let’s say we have to mark some points on a map of a game that has two-dimensional coordinates. We might expect to find a
function like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mark_coordinate</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">width</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coord</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">grid</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">MARKED</span>
</pre></div>
</div>
<p>Now, the part that checks the condition of the first if statement seems convoluted; it doesn’t reveal the intention of
the code, it’s not expressive, and worst of all it calls for code duplication (every part of the code where we need to
check the boundaries before proceeding will have to repeat that if statement).</p>
<p>What if the map itself (called grid on the code) could answer this question? Even better, what if the map could delegate
this action to an even smaller (and hence more cohesive) object? Therefore, we can ask the map if it contains a
coordinate, and the map itself can have information about its limit, and ask this object the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Boundaries</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coord</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>

<span class="k">class</span> <span class="nc">Grid</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="n">Boundaries</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span>
</pre></div>
</div>
<p>This code alone is a much better implementation. First, it is doing a simple composition and it’s using delegation to
solve the problem. Both objects are really cohesive, having the minimal possible logic; the methods are short, and the
logic speaks for itself: <code class="docutils literal notranslate"><span class="pre">coord</span> <span class="pre">in</span> <span class="pre">self.limits</span></code> is pretty much a declaration of the problem to solve, expressing the
intention of the code.</p>
<p>From the outside, we can also see the benefits. It’s almost as if Python is solving the problem for us:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mark_coordinate</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">coord</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">MARKED</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-attributes-for-objects">
<h2>6. Dynamic attributes for objects<a class="headerlink" href="#dynamic-attributes-for-objects" title="Permalink to this headline">¶</a></h2>
<p>It is possible to control the way attributes are obtained from objects by means of the <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> magic method.
When we call something like <code class="docutils literal notranslate"><span class="pre">&lt;myobject&gt;.&lt;myattribute&gt;</span></code>, Python will look for <code class="docutils literal notranslate"><span class="pre">&lt;myattribute&gt;</span></code> in the dictionary of
the object, calling <code class="docutils literal notranslate"><span class="pre">__getattribute__</span></code> on it. If this is not found (namely, the object does not have the attribute we
are looking for), then the extra method, <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code>, is called, passing the name of the attribute (myattribute) as
a parameter. By receiving this value, we can control the way things should be returned to our objects. We can even
create new attributes, and so on.</p>
<p>In the following listing, the <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> method is demonstrated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DynamicAttributes</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fallback_&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;fallback_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;[fallback resolved] {name}&quot;</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;{self.__class__.__name__} has no attribute {attr}&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here are some calls to an object of this class:</p>
<p>The first call is straightforward, we just request an attribute that the object has and get its value as a result. The
second is where this method takes action because the object does not have anything called <code class="docutils literal notranslate"><span class="pre">fallback_test</span></code>, so the
<code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> will run with that value. Inside that method, we placed the code that returns a string, and what we get
is the result of that transformation.</p>
<p>The third example is interesting because there a new attribute named fallback_new is created (actually, this call would
be the same as running <code class="docutils literal notranslate"><span class="pre">dyn.fallback_new</span> <span class="pre">=</span> <span class="pre">&quot;new</span> <span class="pre">value&quot;</span></code>), so when we request that attribute, notice that the logic we
put in <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> does not apply, simply because that code is never called.</p>
<p>Now, the last example is the most interesting one. There is a subtle detail here that makes a huge difference. Take
another look at the code in the <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code> method. Notice the exception it raises when the value is not retrievable
AttributeError. This is not only for consistency (as well as the message in the exception) but also required by the
builtin <code class="docutils literal notranslate"><span class="pre">getattr()</span></code> function. Had this exception been any other, it would raise, and the default value would not be
returned.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be careful when implementing a method so dynamic as <code class="docutils literal notranslate"><span class="pre">__getattr__</span></code>, and use it with caution. When implementing it,
raise AttributeError.</p>
</div>
</div>
<div class="section" id="callable-objects">
<h2>7. Callable objects<a class="headerlink" href="#callable-objects" title="Permalink to this headline">¶</a></h2>
<p>It is possible (and often convenient) to define objects that can act as functions. One of the most common applications
for this is to create better decorators, but it’s not limited to that.</p>
<p>The magic method <code class="docutils literal notranslate"><span class="pre">__call__</span></code> will be called when we try to execute our object as if it were a regular function. Every
argument passed to it will be passed along to the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method. The main advantage of implementing functions this way, through objects, is that objects have states, so we can save and
maintain information across calls.</p>
<p>When we have an object, a statement like this <code class="docutils literal notranslate"><span class="pre">object(*args,</span> <span class="pre">**kwargs)</span></code> is translated in Python to
<code class="docutils literal notranslate"><span class="pre">object.__call__(*args,</span> <span class="pre">**kwargs)</span></code>. This method is useful when we want to create callable objects that will work as
parametrized functions, or in some cases functions with memory.</p>
<p>The following listing uses this method to construct an object that when called with a parameter returns the number of
times it has been called with the very same value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">class</span> <span class="nc">CallCount</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counts</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span>
</pre></div>
</div>
<p>Some examples of this class in action are as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cc</span> <span class="o">=</span> <span class="n">CallCount</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cc</span><span class="p">(</span><span class="s2">&quot;something&quot;</span><span class="p">)</span>
<span class="go">1</span>
</pre></div>
</div>
</div>
<div class="section" id="caveats-in-python">
<h2>8. Caveats in Python<a class="headerlink" href="#caveats-in-python" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mutable-default-arguments">
<h3>8.1. Mutable default arguments<a class="headerlink" href="#mutable-default-arguments" title="Permalink to this headline">¶</a></h3>
<p>Simply put, don’t use mutable objects as the default arguments of functions. If you use mutable objects as default
arguments, you will get results that are not the expected ones. Consider the following erroneous function definition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wrong_user_display</span><span class="p">(</span><span class="n">user_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">user_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">user_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{name} ({age})&quot;</span>
</pre></div>
</div>
<p>This has two problems, actually. Besides the default mutable argument, the body of the function is mutating a mutable
object, hence creating a side effect. But the main problem is the default argument for <code class="docutils literal notranslate"><span class="pre">user_medatada</span></code>.</p>
<p>This will actually only work the first time it is called without arguments. For the second time, we call it without
explicitly passing something to <code class="docutils literal notranslate"><span class="pre">user_metadata</span></code>. It will fail with a KeyError, like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wrong_user_display</span><span class="p">()</span>
<span class="go">&#39;John (30)&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wrong_user_display</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Jane&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>
<span class="go">&#39;Jane (25)&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wrong_user_display</span><span class="p">()</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr"> File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr"> File ... in wrong_user_display</span>
<span class="gr"> name = user_metadata.pop(&quot;name&quot;)</span>
<span class="gr">KeyError</span>: <span class="n">&#39;name&#39;</span>
</pre></div>
</div>
<p>The explanation is simple—by assigning the dictionary with the default data to <code class="docutils literal notranslate"><span class="pre">user_metadata</span></code> on the definition of
the function, this dictionary is actually created once and the variable <code class="docutils literal notranslate"><span class="pre">user_metadata</span></code> points to it. The body of the
function modifies this object, which remains alive in memory so long as the program is running. When we pass a value to
it, this will take the place of the default argument we just created. When we don’t want this object it is called again,
and it has been modified since the previous run; the next time we run it, will not contain the keys since they were
removed on the previous call.</p>
<p>The fix is also simple: we need to use None as a default sentinel value and assign the default on the body of the
function. Because each function has its own scope and life cycle, <code class="docutils literal notranslate"><span class="pre">user_metadata</span></code> will be assigned to the dictionary
every time None appears:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">user_display</span><span class="p">(</span><span class="n">user_metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">user_metadata</span> <span class="o">=</span> <span class="n">user_metadata</span> <span class="ow">or</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">user_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">user_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{name} ({age})&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="extending-built-in-types">
<h3>8.2. Extending built-in types<a class="headerlink" href="#extending-built-in-types" title="Permalink to this headline">¶</a></h3>
<p>The correct way of extending built-in types such as lists, strings, and dictionaries is by means of the collections
module.</p>
<p>If you create a class that directly extends dict, for example, you will obtain results that are probably not what you
are expecting. The reason for this is that in CPython the methods of the class don’t call each other (as they should),
so if you override one of them, this will not be reflected by the rest, resulting in unexpected outcomes. For example,
you might want to override <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, and then when you iterate the object with a for loop, you will notice that
the logic you have put on that method is not applied.</p>
<p>This is all solved by using collections.UserDict, for example, which provides a transparent interface to actual
dictionaries, and is more robust.</p>
<p>Let’s say we want a list that was originally created from numbers to convert the values to strings, adding a prefix. The
first approach might look like it solves the problem, but it is erroneous:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BadList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
         <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;even&quot;</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;odd&quot;</span>
         <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;[{prefix}] {value}&quot;</span>
</pre></div>
</div>
<p>At first sight, it looks like the object behaves as we want it to. But then, if we try to iterate it (after all, it is a
list), we find that we don’t get what we wanted:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bl</span> <span class="o">=</span> <span class="n">BadList</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&#39;[even] 0&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="go">&#39;[odd] 1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">sequence item 0: expected str instance, int found</span>
</pre></div>
</div>
<p>The join function will try to iterate (run a for loop over) the list, but expects values of type string. This should
work because it is exactly the type of change we made to the list, but apparently when the list is being iterated, our
changed version of the __getitem__ is not being called.</p>
<p>This issue is actually an implementation detail of CPython (a C optimization), and in other platforms such as PyPy it
doesn’t happen. Regardless of this, we should write code that is portable and compatible in all implementations, so we
will fix it by extending not from list but from UserList:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">UserList</span>

<span class="k">class</span> <span class="nc">GoodList</span><span class="p">(</span><span class="n">UserList</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
         <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;even&quot;</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;odd&quot;</span>
         <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;[{prefix}] {value}&quot;</span>
</pre></div>
</div>
<p>And now things look much better:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">gl</span> <span class="o">=</span> <span class="n">GoodList</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">&#39;[even] 0&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">gl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="go">&#39;[odd] 1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gl</span><span class="p">)</span>
<span class="go">&#39;[even] 0; [odd] 1; [even] 2&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Don’t extend directly from <code class="docutils literal notranslate"><span class="pre">dict</span></code>, use <code class="docutils literal notranslate"><span class="pre">collections.UserDict</span></code> instead. For lists, use <code class="docutils literal notranslate"><span class="pre">collections.UserList</span></code>, and
for strings, use <code class="docutils literal notranslate"><span class="pre">collections.UserString</span></code>.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../3_general_traits/index.html" class="btn btn-neutral float-right" title="General traits of good code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../1_docstrings_and_annotations/index.html" class="btn btn-neutral float-left" title="Docstrings and annotations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sergio Bugallo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>