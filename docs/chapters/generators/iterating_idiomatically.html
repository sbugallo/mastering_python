

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Iterating idiomatically &mdash; Mastering Python</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/styles.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Mastering Python
          

          
            
            <img src="../../_static/logo-white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                03/03/2020
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../how_python_works/index.html">How does Python work?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development_environments/index.html">Modern Python Development Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pythonic_code/index.html">Pythonic code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general_traits/index.html">General traits of good code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../solid_principles/index.html">SOLID</a></li>
<li class="toctree-l1"><a class="reference internal" href="../decorators/index.html">Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../descriptors/index.html">Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Generators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metaprogramming/index.html">Metaprogramming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../naming/index.html">Naming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unit_testing/index.html">Unit testing and refactoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_patterns/index.html">Design patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clean_architecture/index.html">Clean architecture</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Mastering Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>2. Iterating idiomatically</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/chapters/generators/iterating_idiomatically.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="iterating-idiomatically">
<h1>2. Iterating idiomatically<a class="headerlink" href="#iterating-idiomatically" title="Permalink to this headline">¶</a></h1>
<p>In this section, we will first explore some idioms that come in handy when we have to deal
with iteration in Python. These code recipes will help us get a better idea of the types of
things we can do with generators (especially after we have already seen generator
expressions), and how to solve typical problems in relation to them.</p>
<p>Once we have seen some idioms, we will move on to exploring iteration in Python in more
depth, analyzing the methods that make iteration possible, and how iterable objects work.</p>
<div class="section" id="idioms-for-iteration">
<h2>2.1. Idioms for iteration<a class="headerlink" href="#idioms-for-iteration" title="Permalink to this headline">¶</a></h2>
<p>We are already familiar with the built-in <code class="docutils literal notranslate"><span class="pre">enumerate()</span></code> function that, given an iterable, will
return another one on which the element is a tuple, whose first element is the enumeration
of the second one (corresponding to the element in the original iterable):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="s2">&quot;abcdef&quot;</span><span class="p">))</span>
<span class="go">[(0, &#39;a&#39;), (1, &#39;b&#39;), (2, &#39;c&#39;), (3, &#39;d&#39;), (4, &#39;e&#39;), (5, &#39;f&#39;)]</span>
</pre></div>
</div>
<p>We wish to create a similar object, but in a more low-level fashion; one that can simply
create an infinite sequence. We want an object that can produce a sequence of numbers,
from a starting one, without any limits.</p>
<p>An object as simple as the following one can do the trick. Every time we call this object, we
get the next number of the sequence <em>ad infinitum</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NumberSequence</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">current</span>
</pre></div>
</div>
<p>Based on this interface, we would have to use this object by explicitly invoking its next()
method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">seq</span> <span class="o">=</span> <span class="n">NumberSequence</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seq</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seq</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seq2</span> <span class="o">=</span> <span class="n">NumberSequence</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seq2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seq2</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="go">11</span>
</pre></div>
</div>
<p>But with this code, we cannot reconstruct the <code class="docutils literal notranslate"><span class="pre">enumerate()</span></code> function as we would like to,
because its interface does not support being iterated over a regular Python for loop, which
also means that we cannot pass it as a parameter to functions that expect something to
iterate over. Notice how the following code fails:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; list(zip(NumberSequence(), &quot;abcdef&quot;))
Traceback (most recent call last):
File &quot;...&quot;, line 1, in &lt;module&gt;
TypeError: zip argument #1 must support iteration
</pre></div>
</div>
<p>The problem lies in the fact that <code class="docutils literal notranslate"><span class="pre">NumberSequence</span></code> does not support iteration. To fix this,
we have to make the object an iterable by implementing the magic
method <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code>. We have also changed the previous <code class="docutils literal notranslate"><span class="pre">next()</span></code> method, by using the
magic method <code class="docutils literal notranslate"><span class="pre">__next__</span></code>, which makes the object an iterator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SequenceOfNumbers</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">current</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>
</div>
<p>This has an advantage: not only can we iterate over the element, we also don’t even need
the <code class="docutils literal notranslate"><span class="pre">next()</span></code> method any more because having <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> allows us to use the
<code class="docutils literal notranslate"><span class="pre">next()</span></code> built-in function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">SequenceOfNumbers</span><span class="p">(),</span> <span class="s2">&quot;abcdef&quot;</span><span class="p">))</span>
<span class="go">[(0, &#39;a&#39;), (1, &#39;b&#39;), (2, &#39;c&#39;), (3, &#39;d&#39;), (4, &#39;e&#39;), (5, &#39;f&#39;)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">seq</span> <span class="o">=</span> <span class="n">SequenceOfNumbers</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
<span class="go">100</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
<span class="go">101</span>
</pre></div>
</div>
<div class="section" id="the-next-function">
<h3>2.1.1. The next() function<a class="headerlink" href="#the-next-function" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">next()</span></code> built-in function will advance the iterable to its next element and return it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">word</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<span class="go">&#39;h&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<span class="go">&#39;e&#39;</span>
</pre></div>
</div>
<p>If the iterator does not have more elements to produce, the <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception is
raised:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; ...
&gt;&gt;&gt; next(word)
&#39;o&#39;
&gt;&gt;&gt; next(word)
Traceback (most recent call last):
File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
StopIteration
</pre></div>
</div>
<p>This exception signals that the iteration is over and that there are no more elements to
consume.</p>
<p>If we wish to handle this case, besides catching the <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code> exception, we could
provide this function with a default value in its second parameter. Should this be provided,
it will be the return value in lieu of throwing <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s2">&quot;default value&quot;</span><span class="p">)</span>
<span class="go">&#39;default value&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-a-generator">
<h3>2.1.2. Using a generator<a class="headerlink" href="#using-a-generator" title="Permalink to this headline">¶</a></h3>
<p>The previous code can be simplified significantly by simply using a generator. Generator
objects are iterators. This way, instead of creating a class, we can define a function that
<code class="docutils literal notranslate"><span class="pre">yield</span></code> the values as needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sequence</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">start</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Remember that from our first definition, the <code class="docutils literal notranslate"><span class="pre">yield</span></code> keyword in the body of the function
makes it a generator. Because it is a generator, it’s perfectly fine to create an infinite loop
like this, because, when this generator function is called, it will run all the code until the
next <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement is reached. It will produce its value and suspend there:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">seq</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
<span class="go">11</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sequence</span><span class="p">(),</span> <span class="s2">&quot;abcdef&quot;</span><span class="p">))</span>
<span class="go">[(0, &#39;a&#39;), (1, &#39;b&#39;), (2, &#39;c&#39;), (3, &#39;d&#39;), (4, &#39;e&#39;), (5, &#39;f&#39;)]</span>
</pre></div>
</div>
</div>
<div class="section" id="itertools">
<h3>2.1.3. Itertools<a class="headerlink" href="#itertools" title="Permalink to this headline">¶</a></h3>
<p>Working with iterables has the advantage that the code blends better with Python itself
because iteration is a key component of the language. Besides that, we can take full
advantage of the itertools module. Actually, the <code class="docutils literal notranslate"><span class="pre">sequence()</span></code> generator we
just created is fairly similar to <code class="docutils literal notranslate"><span class="pre">itertools.count()</span></code>. However, there is more we can do.</p>
<p>One of the nicest things about iterators, generators, and itertools, is that they are
composable objects that can be chained together.</p>
<p>For instance, getting back to our first example that processed purchases in order to get
some metrics, what if we want to do the same, but only for those values over a certain
threshold? The naive approach of solving this problem would be to place the condition
while iterating:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">purchase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">purchases</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">purchase</span> <span class="o">&gt;</span> <span class="mf">1000.0</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>This is not only non-Pythonic, but it’s also rigid (and rigidity is a trait that denotes bad
code). It doesn’t handle changes very well. What if the number changes now? Do we pass it
by parameter? What if we need more than one? What if the condition is different (less than,
for instance)? Do we pass a lambda?</p>
<p>These questions should not be answered by this object, whose sole responsibility is to
compute a set of well-defined metrics over a stream of purchases represented as numbers.
And, of course, the answer is no. It would be a huge mistake to make such a change (once
again, clean code is flexible, and we don’t want to make it rigid by coupling this object to
external factors). These requirements will have to be addressed elsewhere.</p>
<p>It’s better to keep this object independent of its clients. The less responsibility this class has,
the more useful it will be for more clients, hence enhancing its chances of being reused.</p>
<p>Instead of changing this code, we’re going to keep it as it is and assume that the new data is
filtered according to whatever requirements each customer of the class has.</p>
<p>For instance, if we wanted to process only the first 10 purchases that amount to more than
1,000, we would do the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">purchases</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">purchases</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">PurchasesStats</span><span class="p">(</span><span class="n">purchases</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
<p>There is no memory penalization for filtering this way because since they all are generators,
the evaluation is always lazy. This gives us the power of thinking as if we had filtered the
entire set at once and then passed it to the object, but without actually fitting everything in
memory.</p>
</div>
<div class="section" id="simplifying-code-through-iterators">
<h3>2.1.4. Simplifying code through iterators<a class="headerlink" href="#simplifying-code-through-iterators" title="Permalink to this headline">¶</a></h3>
<p>Now, we will briefly discuss some situations that can be improved with the help of
iterators, and occasionally the itertools module. After discussing each case, and its
proposed optimization, we will close each point with a corollary.</p>
<div class="section" id="repeated-iterations">
<h4>2.1.4.1. Repeated iterations<a class="headerlink" href="#repeated-iterations" title="Permalink to this headline">¶</a></h4>
<p>Now that we have seen more about iterators, and introduced the itertools module, we
can show you how one of the first examples of this chapter (the one for computing statistics
about some purchases), can be dramatically simplified:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_purchases</span><span class="p">(</span><span class="n">purchases</span><span class="p">):</span>
    <span class="n">min_iter</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">avg_iter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">purchases</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_iter</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_iter</span><span class="p">),</span> <span class="n">median</span><span class="p">(</span><span class="n">avg_iter</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">itertools.tee</span></code> will split the original iterable into three new ones. We
will use each of these for the different kinds of iterations that we require, without needing
to repeat three different loops over purchases.</p>
<p>The reader can simply verify that if we pass an iterable object as the purchases parameter,
this one is traversed only once (thanks to the itertools.tee function),
which was our main requirement. It is also possible to verify how this version is equivalent
to our original implementation. In this case, there is no need to manually raise <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>
because passing an empty sequence to the <code class="docutils literal notranslate"><span class="pre">min()</span></code> function will do the same.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are thinking about running a loop over the same object more than
one time, stop and think if itertools.tee can be of any help.</p>
</div>
</div>
<div class="section" id="nested-loops">
<h4>2.1.4.2. Nested loops<a class="headerlink" href="#nested-loops" title="Permalink to this headline">¶</a></h4>
<p>In some situations, we need to iterate over more than one dimension, looking for a value,
and nested loops come as the first idea. When the value is found, we need to stop iterating,
but the <code class="docutils literal notranslate"><span class="pre">break</span></code> keyword doesn’t work entirely because we have to escape from two (or
more) for loops, not just one.</p>
<p>What would be the solution for this? A flag signaling escape? No. Raising an exception?
No, this would be the same as the flag, but even worse because we know that exceptions
are not to be used for control flow logic. Moving the code to a smaller function and return
it? Close, but not quite.</p>
<p>The answer is, whenever possible, flat the iteration to a single for loop.
This is the kind of code we would like to avoid:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">search_nested_bad</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">desired_value</span><span class="p">):</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="n">desired_value</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{desired_value}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;value </span><span class="si">%r</span><span class="s2"> found at [</span><span class="si">%i</span><span class="s2">, </span><span class="si">%i</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">desired_value</span><span class="p">,</span> <span class="o">*</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coords</span>
</pre></div>
</div>
<p>And here is a simplified version of it that does not rely on flags to signal termination, and
has a simpler, more compact structure of iteration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_iterate_array2d</span><span class="p">(</span><span class="n">array2d</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">array2d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">cell</span>

<span class="k">def</span> <span class="nf">search_nested</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">desired_value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">coord</span> <span class="k">for</span> <span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_iterate_array2d</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="n">desired_value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{desired_value}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;value </span><span class="si">{desired_value}</span><span class="s2"> found at </span><span class="si">{coords}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord</span>
</pre></div>
</div>
<p>It’s worth mentioning how the auxiliary generator that was created works as an abstraction
for the iteration that’s required. In this case, we just need to iterate over two dimensions,
but if we needed more, a different object could handle this without the client needing to
know about it. This is the essence of the iterator design pattern, which, in Python, is
transparent, since it supports iterator objects automatically, which is the topic covered in
the next section.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Try to simplify the iteration as much as possible with as many abstractions as are required, flatting the
loops whenever possible.</p>
</div>
</div>
</div>
</div>
<div class="section" id="the-iterator-pattern-in-python">
<h2>2.2. The iterator pattern in Python<a class="headerlink" href="#the-iterator-pattern-in-python" title="Permalink to this headline">¶</a></h2>
<p>Here, we will take a small detour from generators to understand iteration in Python more
deeply. Generators are a particular case of iterable objects, but iteration in Python goes
beyond generators, and being able to create good iterable objects will give us the chance to
create more efficient, compact, and readable code.</p>
<p>In the previous code listings, we have been seeing examples of iterable objects that are
also iterators, because they implement both the <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code> and <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> magic
methods. While this is fine in general, it’s not strictly required that they always have to
implement both methods, and here we’ll show the subtle differences between
an iterable object (one that implements <code class="docutils literal notranslate"><span class="pre">__iter__</span></code>) and an iterator (that
implements <code class="docutils literal notranslate"><span class="pre">__next__</span></code>).</p>
<p>We also explore other topics related to iterations, such as sequences and container objects.</p>
<div class="section" id="the-interface-for-iteration">
<h3>2.2.1. The interface for iteration<a class="headerlink" href="#the-interface-for-iteration" title="Permalink to this headline">¶</a></h3>
<p>An iterable is an object that supports iteration, which, at a very high level, means that we
can run a <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">..</span> <span class="pre">in</span> <span class="pre">...</span></code> loop over it, and it will work without any issues. However, iterable does not mean
the same as iterator.</p>
<p>Generally speaking, an iterable is just something we can iterate, and it uses an iterator to do
so. This means that in the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> magic method, we would like to return an iterator,
namely, an object with a <code class="docutils literal notranslate"><span class="pre">__next__()</span></code> method implemented.</p>
<p>An iterator is an object that only knows how to produce a series of values, one at a time,
when it’s being called by the already explored built-in <code class="docutils literal notranslate"><span class="pre">next()</span></code> function. While the iterator
is not called, it’s simply frozen, sitting idly by until it’s called again for the next value to
produce. In this sense, generators are iterators.</p>
<p>In the following code, we will see an example of an iterator object that is not iterable: it
only supports invoking its values, one at a time. Here, the name sequence refers just to a
series of consecutive numbers, not to the sequence concept in Python, which will we
explore later on:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SequenceIterator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
        <span class="k">return</span> <span class="n">value</span>
</pre></div>
</div>
<p>Notice that we can get the values of the sequence one at a time, but we can’t iterate over this
object (this is fortunate because it would otherwise result in an endless loop):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">si</span> <span class="o">=</span> <span class="n">SequenceIterator</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">SequenceIterator</span><span class="p">():</span> <span class="k">pass</span>
<span class="gp">...</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">&#39;SequenceIterator&#39; object is not iterable</span>
</pre></div>
</div>
<p>The error message is clear, as the object doesn’t implement <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code>.</p>
<p>Just for explanatory purposes, we can separate the iteration in another object (again, it
would be enough to make the object implement both <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__next__</span></code>, but doing
so separately will help clarify the distinctive point we’re trying to make in this explanation).</p>
</div>
<div class="section" id="sequence-objects-as-iterables">
<h3>2.2.2. Sequence objects as iterables<a class="headerlink" href="#sequence-objects-as-iterables" title="Permalink to this headline">¶</a></h3>
<p>As we have just seen, if an object implements the <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code> magic method, it means it
can be used in a for loop. While this is a great feature, it’s not the only possible form of
iteration we can achieve. When we write a for loop, Python will try to see if the object
we’re using implements <code class="docutils literal notranslate"><span class="pre">__iter__</span></code>, and, if it does, it will use that to construct the iteration,
but if it doesn’t, there are fallback options.</p>
<p>If the object happens to be a sequence (meaning that it implements <code class="docutils literal notranslate"><span class="pre">__getitem__()</span></code>
and <code class="docutils literal notranslate"><span class="pre">__len__()</span></code> magic methods), it can also be iterated. If that is the case, the interpreter
will then provide values in sequence, until the <code class="docutils literal notranslate"><span class="pre">IndexError</span></code> exception is raised, which,
analogous to the aforementioned <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>, also signals the stop for the iteration.</p>
<p>With the sole purpose of illustrating such a behavior, we run the following experiment that
shows a sequence object that implements <code class="docutils literal notranslate"><span class="pre">map()</span></code> over a range of numbers:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MappedRange</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Apply a transformation to a range of numbers.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformation</span> <span class="o">=</span> <span class="n">transformation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrapped</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapped</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformation</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{index}</span><span class="s2">: </span><span class="si">{result}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wrapped</span><span class="p">)</span>
</pre></div>
</div>
<p>Keep in mind that this example is only designed to illustrate that an object such as this one
can be iterated with a regular for loop. There is a logging line placed in the <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>
method to explore what values are passed while the object is being iterated, as we can see
from the following test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mr</span> <span class="o">=</span> <span class="n">MappedRange</span><span class="p">(</span><span class="nb">abs</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">Index 0: 10</span>
<span class="go">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">Index -1: 4</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">mr</span><span class="p">)</span>
<span class="go">Index 0: 10</span>
<span class="go">Index 1: 9</span>
<span class="go">Index 2: 8</span>
<span class="go">Index 3: 7</span>
<span class="go">Index 4: 6</span>
<span class="go">Index 5: 5</span>
<span class="go">Index 6: 4</span>
<span class="go">Index 7: 3</span>
<span class="go">Index 8: 2</span>
<span class="go">Index 9: 1</span>
<span class="go">Index 10: 0</span>
<span class="go">Index 11: 1</span>
<span class="go">Index 12: 2</span>
<span class="go">Index 13: 3</span>
<span class="go">Index 14: 4</span>
<span class="go">[10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0, 1, 2, 3, 4]</span>
</pre></div>
</div>
<p>As a word of caution, it’s important to highlight that while it is useful to know this, it’s also
a fallback mechanism for when the object doesn’t implement <code class="docutils literal notranslate"><span class="pre">__iter__</span></code>, so most of the time
we’ll want to resort to these methods by thinking in creating proper sequences, and not just
objects we want to iterate over.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When thinking about designing an object for iteration, favor a proper
iterable object (with <code class="docutils literal notranslate"><span class="pre">__iter__</span></code>), rather than a sequence that can
coincidentally also be iterated.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sergio Bugallo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>