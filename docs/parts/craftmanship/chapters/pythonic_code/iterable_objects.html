

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5. Iterable objects &mdash; Mastering Python</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/styles.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Mastering Python
          

          
            
            <img src="../../../../_static/logo-white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                05/03/2020
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Craftmanship</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structures_algorithms/index.html">Data structures and algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quality/index.html">Code quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization/index.html">Code optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../technical_architecture/index.html">Technical architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../low_level/index.html">Low level Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distribution/index.html">Code distribution</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Mastering Python</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
      <li>5. Iterable objects</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/parts/craftmanship/chapters/pythonic_code/iterable_objects.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="iterable-objects">
<h1>5. Iterable objects<a class="headerlink" href="#iterable-objects" title="Permalink to this headline">¶</a></h1>
<p>In Python, we have objects that can be iterated by default: lists, tuples, sets and dictionaries. However, the built-in
iterable objects are not the only kind that we can have in a for loop. We could also create our own iterable, with the
logic we define for iteration.</p>
<p>In order to achieve this, we rely on magic methods. Iteration works in Python by its own protocol (namely the iteration
protocol). When you try to iterate an object in the form <code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">e</span> <span class="pre">in</span> <span class="pre">myobject:</span></code>…, what Python checks at a very high
level are the following two things, in order:</p>
<ul class="simple">
<li><p>If the object contains one of the iterator methods <code class="docutils literal notranslate"><span class="pre">__next__</span></code> or <code class="docutils literal notranslate"><span class="pre">__iter__</span></code></p></li>
<li><p>If the object is a sequence and has <code class="docutils literal notranslate"><span class="pre">__len__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code></p></li>
</ul>
<p>Therefore, as a fallback mechanism, sequences can be iterated, and so there are two ways of customizing our objects to
be able to work on for loops.</p>
<div class="section" id="creating-iterable-objects">
<h2>5.1. Creating iterable objects<a class="headerlink" href="#creating-iterable-objects" title="Permalink to this headline">¶</a></h2>
<p>When we try to iterate an object, Python will call the <code class="docutils literal notranslate"><span class="pre">iter()</span></code> function over it. One of the first things this
function checks for is the presence of the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method on that object, which, if present, will be executed.
<code class="docutils literal notranslate"><span class="pre">__iter__</span></code> should return the iterator itself.</p>
<p>The following code creates an object that allows iterating over a range of dates, producing one day at a time on every
round of the loop:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="k">class</span> <span class="nc">DateRangeIterable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An iterable that contains its own iterator object.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span> <span class="o">=</span> <span class="n">start_date</span>

 <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span>

 <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="n">today</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_present_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">today</span>
</pre></div>
</div>
<p>This object is designed to be created with a pair of dates, and when iterated, it will produce each day in the interval
of specified dates, which is shown in the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">DateRangeIterable</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)):</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>

<span class="go">2018-01-01</span>
<span class="go">2018-01-02</span>
<span class="go">2018-01-03</span>
<span class="go">2018-01-04</span>
</pre></div>
</div>
<p>Here, the for loop is starting a new iteration over our object. At this point, Python will call the <code class="docutils literal notranslate"><span class="pre">iter()</span></code> function
on it, which in turn will call the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> magic method. On this method, it is defined to return <code class="docutils literal notranslate"><span class="pre">self</span></code>,
indicating that the object is an iterable itself, so at that point every step of the loop will call the <code class="docutils literal notranslate"><span class="pre">next()</span></code>
function on that object, which delegates to the <code class="docutils literal notranslate"><span class="pre">__next__</span></code> method. In this method, we decide how to produce the
elements and return one at a time. When there is nothing else to produce, we have to signal this to Python by raising
the StopIteration exception.</p>
<p>This means that what is actually happening is similar to Python calling <code class="docutils literal notranslate"><span class="pre">next()</span></code> every time on our object until there
is a StopIteration exception, on which it knows it has to stop the for loop:</p>
<p>This example works, but it has a small problem—once exhausted, the iterable will continue to be empty, hence raising
StopIteration. This means that if we use this on two or more consecutive for loops, only the first one will work, while
the second one will be empty:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">r1</span> <span class="o">=</span> <span class="n">DateRangeIterable</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">r1</span><span class="p">))</span>
<span class="go">&#39;2018-01-01, 2018-01-02, 2018-01-03, 2018-01-04&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr"> File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr">ValueError</span>: <span class="n">max() arg is an empty sequence</span>
</pre></div>
</div>
<p>This is because of the way the iteration protocol works: an iterable constructs an iterator, and this one is the one
being iterated over. In our example, <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> just returned self, but we can make it create a new iterator every
time it is called. One way of fixing this would be to create new instances of DateRangeIterable, which is not a
terrible issue, but we can make <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> use a generator (which are iterator objects), which is being created
every time:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DateRangeContainerIterable</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">current_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>
        <span class="k">while</span> <span class="n">current_day</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">current_day</span>

        <span class="n">current_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>And this time, it works:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">r1</span> <span class="o">=</span> <span class="n">DateRangeContainerIterable</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">r1</span><span class="p">))</span>
<span class="go">&#39;2018-01-01, 2018-01-02, 2018-01-03, 2018-01-04&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">max</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
<span class="go">datetime.date(2018, 1, 4)</span>
</pre></div>
</div>
<p>The difference is that each for loop is calling <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> again, and each one of those is creating the generator
again. This is called a container iterable.</p>
<p>..note:: In general, it is a good idea to work with container iterables when dealing with generators.</p>
</div>
<div class="section" id="creating-sequences">
<h2>5.2. Creating sequences<a class="headerlink" href="#creating-sequences" title="Permalink to this headline">¶</a></h2>
<p>Maybe our object does not define the <code class="docutils literal notranslate"><span class="pre">__iter__()</span></code> method, but we still want to be able to iterate over it. If
<code class="docutils literal notranslate"><span class="pre">__iter__</span></code> is not defined on the object, the <code class="docutils literal notranslate"><span class="pre">iter()</span></code> function will look for the presence of <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code>, and if
this is not found, it will raise TypeError.</p>
<p>A sequence is an object that implements <code class="docutils literal notranslate"><span class="pre">__len__</span></code> and <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and expects to be able to get the elements it
contains, one at a time, in order, starting at zero as the first index. This means that you should be careful in the
logic so that you correctly implement <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> to expect this type of index, or the iteration will not work.</p>
<p>The example from the previous section had the advantage that it uses less memory. This means that is only holding one
date at a time, and knows how to produce the days one by one. However, it has the drawback that if we want to get the
n-th element, we have no way to do so but iterate n-times until we reach it. This is a typical trade-off in computer
science between memory and CPU usage.</p>
<p>The implementation with an iterable will use less memory, but it takes up to O(n) to get an element, whereas
implementing a sequence will use more memory (because we have to hold everything at once), but supports indexing in
constant time, O(1).</p>
<p>This is what the new implementation might look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DateRangeSequence</span><span class="p">:</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_range</span><span class="p">()</span>

     <span class="k">def</span> <span class="nf">_create_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">days</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="n">current_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span>

         <span class="k">while</span> <span class="n">current_day</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">:</span>
             <span class="n">days</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_day</span><span class="p">)</span>
             <span class="n">current_day</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

         <span class="k">return</span> <span class="n">days</span>

     <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_no</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">[</span><span class="n">day_no</span><span class="p">]</span>

     <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_range</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is how the object behaves:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">DateRangeSequence</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">day</span><span class="p">)</span>
<span class="go">2018-01-01</span>
<span class="go">2018-01-02</span>
<span class="go">2018-01-03</span>
<span class="go">2018-01-04</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">datetime.date(2018, 1, 1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="go">datetime.date(2018, 1, 4)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">datetime.date(2018, 1, 4)</span>
</pre></div>
</div>
<p>In the preceding code, we can see that negative indices also work. This is because the DateRangeSequence object
delegates all of the operations to its wrapped object (a list), which is the best way to maintain compatibility and a
consistent behavior.</p>
<p>Evaluate the trade-off between memory and CPU usage when deciding which one of the two possible implementations to use.
In general, the iteration is preferable (and generators even more), but keep in mind the requirements of every case.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sergio Bugallo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>